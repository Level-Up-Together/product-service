name: Build and Deploy (Prod)

on:
  push:
    branches:
      - main

permissions:
  id-token: write   # GitHub OIDC → AWS
  contents: read

env:
  S3_BUCKET: lut-deploy-prod
  APP_NAME: product-be

jobs:
  build:
    name: Build & Upload
    runs-on: ubuntu-latest

    steps:
      # 1. SSH 호스트 키 추가
      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      # 2. 리포지토리 체크아웃 (서브모듈 포함)
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          ssh-key: ${{ secrets.PRIVATE_KEY_FOR_SUBMODULE }}
          fetch-depth: 0

      # 3. 서브모듈 최신화
      - name: Update submodules to the latest
        run: |
          git submodule update --init --recursive
          git submodule foreach git pull origin $(git rev-parse --abbrev-ref HEAD)

      # 4. Keystore 파일 복원
      - name: Restore keystore from secrets
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/src/main/resources/keystore-prod.p12
          echo "Keystore (prod) restored successfully"
        env:
          KEYSTORE_BASE64: ${{ secrets.PROD_KEYSTORE_BASE64 }}

      # 5. JDK 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 6. Gradle 캐시 설정
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 7. Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build --no-daemon
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      # 8. AWS OIDC 인증
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 9. JAR → S3 업로드
      - name: Upload JAR to S3
        run: |
          JAR_FILE=$(ls app/build/libs/*-exec.jar | head -1)
          COMMIT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          # 커밋별 아카이브
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/$APP_NAME/${TIMESTAMP}-${COMMIT_SHA}.jar"

          # latest.jar (배포용)
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/$APP_NAME/latest.jar"

          echo "Uploaded: $JAR_FILE -> s3://$S3_BUCKET/$APP_NAME/latest.jar"

  deploy:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$EC2_1_IP" >> ~/.ssh/known_hosts
          ssh-keyscan -H "$EC2_2_IP" >> ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          EC2_1_IP: ${{ secrets.PROD_EC2_1_IP }}
          EC2_2_IP: ${{ secrets.PROD_EC2_2_IP }}

      # EC2 #1 배포 (순차: 롤링 배포)
      - name: Deploy to EC2 #1
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "ec2-user@$EC2_1_IP" \
            "sudo /opt/apps/deploy.sh $APP_NAME $S3_BUCKET $APP_NAME/latest.jar"
        env:
          EC2_1_IP: ${{ secrets.PROD_EC2_1_IP }}

      # EC2 #2 배포
      - name: Deploy to EC2 #2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "ec2-user@$EC2_2_IP" \
            "sudo /opt/apps/deploy.sh $APP_NAME $S3_BUCKET $APP_NAME/latest.jar"
        env:
          EC2_2_IP: ${{ secrets.PROD_EC2_2_IP }}

  notify:
    name: Slack Notification
    needs: [ build, deploy ]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: action-slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy.result }}
          author_name: Level Up Together Backend - prod
          fields: repo,commit,message,author
          mention: here
          if_mention: failure,cancelled
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.PROD_SLACK_WEBHOOK_URL }}
